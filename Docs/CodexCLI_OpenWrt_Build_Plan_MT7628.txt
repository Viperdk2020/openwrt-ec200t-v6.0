CodexCLI OpenWrt Build Plan — MT7628 (ramips/mt76x8)

Goal
- Routed WAN over Wi‑Fi STA, Wi‑Fi AP (same radio), Ethernet LAN.
- 4G fallback via PPP over /dev/ttyUSBx. ECM/RNDIS DHCP fallback enabled.
- Include LuCI. Strip IPv6, USB storage, unused PPP flavors, non‑MT76 Wi‑Fi drivers.
- Country: Denmark (DK).

Target / Profile
- Target: ramips/mt76x8 (MT7628).
- Suggested PROFILE: mediatek_mt7628an-eval-board (adjust if your board differs).
- Find your exact profile:
  make info | grep -i 7628

Packages
- Add:
  ppp chat kmod-usb-core kmod-usb2 kmod-usb-serial kmod-usb-serial-option kmod-usb-acm \
  usb-modeswitch kmod-usb-net kmod-usb-net-cdc-ether kmod-usb-net-rndis \
  kmod-mt76 wpad-basic-mbedtls \
  firewall4 nftables kmod-nft-nat dnsmasq-full dropbear logd \
  ip-full swconfig luci luci-ssl uhttpd ca-bundle luci-mod-network luci-app-firewall luci-proto-ppp
- Remove:
  odhcp6c luci-proto-ipv6 kmod-ipv6 ppp-mod-pppoe ppp-mod-pppoa \
  kmod-usb-storage block-mount kmod-fs-ext4 kmod-fs-vfat \
  uqmi umbim kmod-usb-net-qmi-wwan kmod-usb-net-cdc-mbim \
  relayd kmod-ath9k kmod-ath10k-ct kmod-brcmfmac

ImageBuilder command (edit PROFILE if needed)
make image PROFILE="mediatek_mt7628an-eval-board" \
  PACKAGES="ppp chat kmod-usb-core kmod-usb2 kmod-usb-serial kmod-usb-serial-option kmod-usb-acm usb-modeswitch kmod-usb-net kmod-usb-net-cdc-ether kmod-usb-net-rndis kmod-mt76 wpad-basic-mbedtls firewall4 nftables kmod-nft-nat dnsmasq-full dropbear logd ip-full swconfig luci luci-ssl uhttpd ca-bundle luci-mod-network luci-app-firewall luci-proto-ppp -odhcp6c -luci-proto-ipv6 -kmod-ipv6 -ppp-mod-pppoe -ppp-mod-pppoa -kmod-usb-storage -block-mount -kmod-fs-ext4 -kmod-fs-vfat -uqmi -umbim -kmod-usb-net-qmi-wwan -kmod-usb-net-cdc-mbim -relayd -kmod-ath9k -kmod-ath10k-ct -kmod-brcmfmac" \
  FILES=files/

Wireless/Network defaults
- STA WAN: SSID "P9000", key "heylotte" (change as needed).
- AP LAN: SSID "OpenWrt-AP", key "changeme123" (change as needed).
- Country: DK, ieee80211w off for compatibility.
- Route priority (lower is preferred): wwan=10, cell PPP=20, usb0 ECM/RNDIS=30.

FILES/ overlay (create these under files/)

BEGIN FILE files/etc/config/wireless
config wifi-device 'radio0'
    option type 'mac80211'
    option path 'platform/10300000.wmac'
    option country 'DK'
    option txpower '20'

# AP on LAN
config wifi-iface
    option device 'radio0'
    option mode 'ap'
    option network 'lan'
    option ssid 'OpenWrt-AP'
    option encryption 'psk2'
    option key 'changeme123'

# STA as routed WAN
config wifi-iface
    option device 'radio0'
    option mode 'sta'
    option network 'wwan'
    option ssid 'P9000'
    option encryption 'psk2'
    option key 'heylotte'
    option ieee80211w '0'
END FILE

BEGIN FILE files/etc/config/network
config interface 'loopback'
    option device 'lo'
    option proto 'static'
    option ipaddr '127.0.0.1'
    option netmask '255.0.0.0'

config interface 'lan'
    option type 'bridge'
    option device 'eth0'
    option proto 'static'
    option ipaddr '192.168.1.1'
    option netmask '255.255.255.0'

# Wi‑Fi STA WAN
config interface 'wwan'
    option proto 'dhcp'
    option metric '10'

# 4G PPP fallback (adjust ttyUSB index if needed)
config interface 'cell'
    option proto 'ppp'
    option device '/dev/ttyUSB3'
    option peerdns '1'
    option defaultroute '1'
    option ipv6 '0'
    option pppd_options 'noauth persist holdoff 5 usepeerdns defaultroute'
    option connect '/usr/sbin/chat -v -s -S -t 30 -f /etc/ppp/chatscripts/cell.chat'

# USB ECM/RNDIS fallback (usb0)
config interface 'wan_usb'
    option proto 'dhcp'
    option device 'usb0'
    option metric '30'
END FILE

BEGIN FILE files/etc/config/firewall
config defaults
    option syn_flood '1'
    option input 'ACCEPT'
    option output 'ACCEPT'
    option forward 'REJECT'

config zone
    option name 'lan'
    list network 'lan'
    option input 'ACCEPT'
    option output 'ACCEPT'
    option forward 'ACCEPT'

config zone
    option name 'wan'
    list network 'wwan'
    list network 'cell'
    list network 'wan_usb'
    option input 'REJECT'
    option output 'ACCEPT'
    option forward 'REJECT'
    option masq '1'
    option mtu_fix '1'

config forwarding
    option src 'lan'
    option dest 'wan'
END FILE

BEGIN FILE files/etc/ppp/chatscripts/cell.chat
ABORT "BUSY"
ABORT "NO CARRIER"
ABORT "NO DIALTONE"
ABORT "ERROR"
ABORT "NO ANSWER"
"" ATZ
OK AT+CGDCONT=1,"IP","data.lycamobile.dk"
OK ATD*99#
CONNECT ""
END FILE

BEGIN FILE files/etc/ppp/peers/cell
/dev/ttyUSB3
115200
crtscts
noauth
defaultroute
usepeerdns
persist
holdoff 5
ipparam cell
connect "/usr/sbin/chat -v -s -S -t 30 -f /etc/ppp/chatscripts/cell.chat"
END FILE

# Hotplug: bind serial driver to known modem IDs and load ECM/RNDIS
BEGIN FILE files/etc/hotplug.d/usb/10-modem-bind
#!/bin/sh
[ "$ACTION" = add ] || exit 0
modprobe usbserial 2>/dev/null
modprobe option 2>/dev/null
modprobe cdc_ether 2>/dev/null
modprobe rndis_host 2>/dev/null

# Marvell/ML352 (example seen on your unit)
echo '1286 4e3c ff' > /sys/bus/usb-serial/drivers/option/new_id 2>/dev/null

# Quectel EC200T (if ever used)
echo '2c7c 6026 ff' > /sys/bus/usb-serial/drivers/option/new_id 2>/dev/null
END FILE

Post-build
- Outputs land in openwrt/bin/targets/ramips/mt76x8/.
- Wrap initramfs/sysupgrade with your MTK RAM header tool before TFTP/flash:
  ./wrap_mt7628_initramfs.sh openwrt/bin/targets/ramips/mt76x8/<image>.bin

First boot checklist
- Verify single STA + AP: ip -br a | grep -E 'phy0-|wlan|wwan'
- STA DHCP: ifstatus wwan | sed -n '1,80p'
- PPP fallback: pppd call cell &; ip -br a show ppp0
- USB fallback: ip -br a show usb0; udhcpc -n -q -i usb0

Notes
- AP shares channel with STA; keep IEEE 802.11w disabled for compatibility.
- If your modem’s tty index isn’t /dev/ttyUSB3, change both files/etc/config/network and files/etc/ppp/peers/cell accordingly.
- IPv6 is omitted. If needed later, add odhcp6c and related kernel modules back.
